# clofri â€” Product Requirements Document

> Presence-first, ephemeral chat for close friends. Messages fade. If you're not here, you miss it.

---

## 1. Product Vision

clofri is a lightweight, real-time chat app designed for small, trusted friend groups. Unlike traditional messengers where conversations accumulate forever, clofri treats conversations as **ephemeral sessions** â€” they have a clear start and end, and messages are deleted when the session closes. The core philosophy is that presence matters: if you're not here, you miss it.

### Target Users
- Small friend groups (2-10 people) who want a casual, low-pressure chat space
- Users who value privacy and don't want permanent message history
- People who want to know when their friends are online and available

### Core Principles
1. **Ephemeral by default** â€” Messages don't persist beyond the session
2. **Presence-first** â€” Always know who's around
3. **Low friction** â€” Magic link login, no app install, minimal setup
4. **Trust-based** â€” Friend codes, invite-only groups, no public discovery

---

## 2. Functional Areas & User Stories

---

### 2.1 Authentication

**Current state:** Magic link email login. Google OAuth method exists in code but is not configured in Supabase.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| AUTH-1 | As a new user, I can sign up by entering my email and clicking a magic link sent to my inbox | âœ… Done | Supabase OTP via `signInWithMagicLink` |
| AUTH-2 | As a returning user, I can log in via the same magic link flow | âœ… Done | Session persists via Supabase auth state |
| AUTH-3 | As a logged-in user, I can log out from the sidebar | âœ… Done | Clears session, redirects to login |
| AUTH-4 | As a new user, my profile is auto-created on first login with my email prefix as display name | âœ… Done | `fetchOrCreateProfile` in authStore |
| AUTH-5 | As a user, I should stay logged in across page refreshes until I explicitly log out | âœ… Done | Supabase session persistence |
| AUTH-6 | As a user, I can sign in with Google OAuth | ðŸ”² Not configured | Code exists (`signInWithGoogle`) but Google Cloud Console OAuth not set up |
| AUTH-8 | As a user, I receive a branded, clear magic link email when logging in | âœ… Done | Customized Supabase email template (subject, body, branding) |
| AUTH-7 | As a user, I see a loading state while my session is being restored | âœ… Done | `loading` flag in authStore |

---

### 2.2 Profile Management

**Current state:** Users can edit their display name, pick a predefined icon avatar, and copy their unique friend code.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| PROF-1 | As a user, I can see my display name, avatar, and friend code in the sidebar | âœ… Done | Layout sidebar profile section |
| PROF-2 | As a user, I can edit my display name inline in the sidebar | âœ… Done | Click pencil icon â†’ inline input â†’ saves to Supabase |
| PROF-3 | As a user, I can pick from a set of predefined icon avatars (cat, dog, etc.) | âœ… Done | AvatarPicker component, stored as `icon:name` in `avatar_url` |
| PROF-4 | As a user, I can copy my unique friend code to share with others | âœ… Done | Copy button with checkmark feedback |
| PROF-5 | As a user, I can upload a custom avatar image | ðŸ”² Future | Requires Supabase Storage integration |
| PROF-6 | As a user, I have a unique auto-generated friend code assigned on profile creation | âœ… Done | 8-char uppercase code generated by DB |

---

### 2.3 Friends

**Current state:** Users add friends via friend code. Friend requests can be sent, accepted, rejected. Friends can be removed.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| FRI-1 | As a user, I can send a friend request by entering someone's friend code | âœ… Done | `sendRequest` in friendStore |
| FRI-2 | As a user, I see an error if I enter my own code, an invalid code, or a code for an existing friend | âœ… Done | Validation in `sendRequest` |
| FRI-3 | As a user, I can see incoming friend requests and accept or reject them | âœ… Done | `pendingReceived` list with accept/reject buttons |
| FRI-4 | As a user, I can see outgoing friend requests that are still pending | âœ… Done | `pendingSent` list with "Pending" badge |
| FRI-5 | As a user, I can remove an existing friend | âœ… Done | Confirm dialog â†’ `removeFriend` deletes the friendship row |
| FRI-6 | As a user, I can see each friend's online status (active/idle/offline) on the Friends page | âœ… Done | Presence dots (green/amber/gray) via lobby channel |
| FRI-7 | As a user, I can start a DM with a friend by clicking the message icon | âœ… Done | Creates/reuses dm_session, navigates to `/dm/:sessionId` |
| FRI-8 | As a user, I can filter my friends list by category | âœ… Done | Category filter dropdown on Friends page |
| FRI-9 | As a user, I receive a success message after sending a friend request | âœ… Done | Green success toast |
| FRI-10 | As a user, the friend request UI resets after a successful send | âœ… Done | Input clears, panel can close |
| FRI-11 | As a user, I should be notified in real-time when I receive a friend request | âœ… Done | `friend_request` lobby broadcast â†’ sound + fetchFriends |
| FRI-12 | As a user, I should be able to search/filter my friends list by name | âœ… Done | Search input (shown when >3 friends) filters across all categories |
| FRI-13 | As a user, I can cancel a sent friend request that is still pending | âœ… Done | X button on sent request cards, deletes the friendship row |

---

### 2.4 Friend Categories

**Current state:** Users can create custom categories, assign friends to them, and filter by category. Data stored in localStorage only.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| CAT-1 | As a user, I can create a named category for organizing friends | âœ… Done | Auto-assigned color from palette |
| CAT-2 | As a user, I can assign a friend to a category | âœ… Done | Dropdown on each friend card |
| CAT-3 | As a user, I can filter the friends list to show only friends in a specific category | âœ… Done | Filter dropdown at top of friends list |
| CAT-4 | As a user, I can delete a category (friends in it become uncategorized) | âœ… Done | Removes category and all its assignments |
| CAT-5 | As a user, my categories persist across page refreshes | âœ… Done | localStorage persistence |
| CAT-6 | As a user, my categories should sync across devices | ðŸ”² Future | Currently localStorage only â€” needs Supabase migration |
| CAT-7 | As a user, I see my friends grouped into collapsible sections by category, with each friend showing their online/offline status within the section | âœ… Done | Category sections with inline status, online sorted to top, uncategorized section for untagged friends |
| CAT-8 | As a user, I can expand/collapse each category section to focus on the group I care about | âœ… Done | Chevron toggle on each section header |

---

### 2.5 Direct Messages (Ephemeral Sessions)

**Current state:** DMs use a dedicated `dm_sessions` table. Sessions are ephemeral â€” either user can end the conversation, which deletes all messages and closes the session for both sides.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| DM-1 | As a user, I can start a DM session with a friend from the Friends page | âœ… Done | `startSession` creates or reuses active dm_session |
| DM-2 | As a user, I can send and receive real-time messages in a DM | âœ… Done | Broadcast channel `dm-session:{id}` |
| DM-3 | As a user, I can see my friend's display name, avatar, and online status in the DM header | âœ… Done | Presence dot + status text |
| DM-4 | As a user, I can see typing indicators when my friend is typing | âœ… Done | "typing..." text in header |
| DM-5 | As a user, I can end a DM session, which deletes all messages and closes the chat for both sides | âœ… Done | XCircle button â†’ confirm â†’ `endSession` |
| DM-6 | As a user, when the other person ends the DM, I hear a notification sound and am redirected to Messages | âœ… Done | `dm_ended` lobby broadcast â†’ sound + redirect |
| DM-7 | As a user, I can see a list of my active DM sessions on the Messages page | âœ… Done | Messages page shows active sessions with presence |
| DM-8 | As a user, I see an unread indicator on DM sessions that have new messages | âœ… Done | Blue dot on session card + Messages nav badge |
| DM-9 | As a user, I hear a notification sound when I receive a DM while on another page | âœ… Done | `new_dm` lobby broadcast â†’ sound + unread |
| DM-10 | As a user, new DM sessions from others appear on my Messages page without a refresh | âœ… Done | Lobby broadcast triggers `fetchSessions` |
| DM-11 | As a user, I see an ephemeral notice in the chat reminding me messages are temporary | âœ… Done | Small text below messages area |
| DM-12 | As a user, messages persist during an active session so I don't lose them on page refresh | âœ… Done | Messages stored in `direct_messages` table during session |
| DM-13 | As a user, I should see a brief "conversation ended" message before being redirected | âœ… Done | Shows "Conversation ended" screen for 2s then redirects to /messages |
| DM-14 | As a user, I should be able to scroll back through older messages in a long conversation | ðŸ”² Future | Currently limited to last 50 messages with no pagination |

---

### 2.6 Groups

**Current state:** Users can create groups, invite others via a 6-character code, and chat in real-time. Groups are ephemeral â€” the creator can end the session, which deletes messages and deactivates the group.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| GRP-1 | As a user, I can create a new group with a name | âœ… Done | `createGroup` generates invite code, adds creator as member with 'creator' role |
| GRP-2 | As a user, I can join a group by entering a 6-character invite code | âœ… Done | `joinGroupByCode` with duplicate handling |
| GRP-3 | As a user, I see an error if I enter an invalid code, already-joined group, or ended session | âœ… Done | Validation + is_active check |
| GRP-4 | As a user, I can see a list of my active groups on the Groups page | âœ… Done | Filtered by `is_active = true` |
| GRP-5 | As a user, I can see group member count and unread indicators on group cards | âœ… Done | Member count badge + blue unread dot |
| GRP-6 | As a user, I can copy a group's invite code to share with friends | âœ… Done | Copy button in GroupChat sidebar |
| GRP-7 | As a user, I can leave a group I'm a member of (with confirmation) | âœ… Done | Leave button with confirm dialog for non-creators |
| GRP-8 | As a group creator, I can delete the group entirely | âœ… Done | Consolidated into End Session (no separate delete) |
| GRP-9 | As a group creator, I can kick a member from the group (with confirmation) | âœ… Done | Kick button with confirm dialog; visible on mobile, hover on desktop |
| GRP-10 | As a group creator, I can end the group session (delete messages, deactivate group) | âœ… Done | End Session button â†’ `endGroupSession` |
| GRP-11 | As a user, I should be notified and redirected when a group session I'm in is ended by the creator | âœ… Done | `group_ended` lobby broadcast â†’ sound + fetchGroups + auto-redirect |
| GRP-12 | As a user, ended groups should disappear from my Groups page | âœ… Done | `fetchGroups` filters by `is_active = true` |
| GRP-13 | As a user, I should see who is currently online in the group member list | âœ… Done | Online status circles next to member names |

---

### 2.7 Group & DM Chat (Real-time Messaging)

**Current state:** Real-time messaging via Supabase Broadcast channels. Messages persisted to DB during active sessions. Last 50 messages shown.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| CHAT-1 | As a user, I can send text messages up to 2000 characters | âœ… Done | DB constraint `char_length(text) <= 2000` |
| CHAT-2 | As a user, I see messages from others appear in real-time without refreshing | âœ… Done | Broadcast channel subscription |
| CHAT-3 | As a user, I see typing indicators when others are composing a message | âœ… Done | Typing broadcast events |
| CHAT-4 | As a user, my sent messages appear instantly (optimistic UI) before server confirms | âœ… Done | Local state update before DB insert |
| CHAT-5 | As a user, I see each message with the sender's avatar, name, and timestamp | âœ… Done | Avatar + name for others, right-aligned for own |
| CHAT-6 | As a user, the chat auto-scrolls to the latest message only when I'm near the bottom | âœ… Done | Smart scroll: only auto-scrolls when near bottom; shows "New messages" pill when scrolled up |
| CHAT-7 | As a user, I hear a notification sound when a new message arrives from someone else | âœ… Done | `playMessageSound` on incoming messages |
| CHAT-8 | As a user, I can see the last 50 messages in a conversation | âœ… Done | Slice to 50 in state + DB query limited to 50 |
| CHAT-12 | As a user, consecutive messages from the same person are visually grouped | âœ… Done | Messages within 2min collapse avatar/name/timestamp |
| CHAT-13 | As a user, URLs I share in chat are clickable links | âœ… Done | `linkifyText` utility detects http/https URLs and renders as `<a>` tags |
| CHAT-14 | As a user, the chat input is auto-focused when I enter a conversation | âœ… Done | `inputRef` focused on mount |
| CHAT-15 | As a user, I can type messages up to 2000 characters (enforced in UI) | âœ… Done | `maxLength={2000}` on both DM and Group chat inputs |
| CHAT-9 | As a user, I should be able to send images or media | ðŸ”² Future | Requires Supabase Storage |
| CHAT-10 | As a user, I should be able to react to messages with emoji | ðŸ”² Future | Requires reactions table + UI |
| CHAT-11 | As a user, I should see link previews when someone shares a URL | ðŸ”² Future | Requires URL detection + OG scraping |

---

### 2.8 Presence & Online Status

**Current state:** Global presence via Supabase Realtime "lobby" channel. Three statuses: active (green), idle (amber), offline (gray).

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| PRES-1 | As a user, I appear as "active" (green) when I'm using the app | âœ… Done | Tracked via lobby presence channel |
| PRES-2 | As a user, I transition to "idle" (amber) after 5 minutes of no mouse/keyboard activity | âœ… Done | `IDLE_TIMEOUT_MS = 5 * 60 * 1000` |
| PRES-3 | As a user, I transition to "idle" immediately when I switch to another tab | âœ… Done | `visibilitychange` event listener |
| PRES-4 | As a user, I return to "active" when I interact with the app again | âœ… Done | Mouse/keyboard/scroll event listeners |
| PRES-5 | As a user, I appear as "offline" (gray) when I close the app | âœ… Done | Channel unsubscribe + stale threshold |
| PRES-6 | As a user, I can see others' presence status on the Friends page, Messages page, and in chat headers | âœ… Done | Presence dots throughout the app |
| PRES-7 | As a user, my status should display correctly to others even if I don't interact for a while | âœ… Done | Heartbeat every 60s keeps `last_active` fresh; stale threshold at 6min |

---

### 2.9 Notifications & Unread Indicators

**Current state:** Sound notifications via Web Audio API, unread tracking via localStorage timestamps, lobby channel broadcasts for cross-page DM notifications.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| NOTIF-1 | As a user, I hear a notification sound when a message arrives in a group I have open | âœ… Done | `playMessageSound` in useChat |
| NOTIF-2 | As a user, I hear a notification sound when a DM arrives while I'm on any page | âœ… Done | `new_dm` lobby broadcast â†’ presenceStore handler |
| NOTIF-3 | As a user, I can toggle notification sounds on/off from the sidebar | âœ… Done | Volume icon toggle, persisted in localStorage |
| NOTIF-4 | As a user, I see a blue dot on group cards that have unread messages | âœ… Done | `unreadGroups` Set + localStorage timestamps |
| NOTIF-5 | As a user, I see a blue dot on DM sessions that have unread messages | âœ… Done | `unreadDMs` Set + localStorage timestamps |
| NOTIF-6 | As a user, I see an unread count badge on the Messages nav item | âœ… Done | `unreadDMCount` in Layout |
| NOTIF-7 | As a user, unread indicators clear when I open the conversation | âœ… Done | `markRead` called on mount |
| NOTIF-8 | As a user, I hear a sound when the other person ends a DM session | âœ… Done | `dm_ended` lobby broadcast |
| NOTIF-9 | As a user, I should receive push notifications when the app is in the background | ðŸ”² Future | Requires service worker + web push |
| NOTIF-10 | As a user, I should hear a sound when a group message arrives while I'm on another page | âœ… Done | `new_group_msg` lobby broadcast â†’ sound + unread if not viewing group |

---

### 2.10 Navigation & Layout

**Current state:** Responsive layout with collapsible desktop sidebar and mobile hamburger menu. Three main pages: Friends (home), Messages, Groups.

| ID | User Story | Status | Notes |
|----|-----------|--------|-------|
| NAV-1 | As a user, I can navigate between Friends, Messages, and Groups via the sidebar | âœ… Done | NavLink with active state highlighting |
| NAV-2 | As a desktop user, I can collapse the sidebar to a narrow icon rail | âœ… Done | Toggle button, persisted in localStorage |
| NAV-3 | As a mobile user, I can open/close the sidebar via a hamburger menu | âœ… Done | Slide-out overlay, auto-closes on navigation |
| NAV-4 | As a user, I see a connection banner when my real-time connection drops | âœ… Done | Red/amber/green banners for disconnected/reconnecting/reconnected |
| NAV-5 | As a user, I am redirected to the login page if my session expires | âœ… Done | Auth guard in App.tsx |
| NAV-6 | As a user, the Friends page is my landing page when I open the app | âœ… Done | Route `/` maps to Friends |
| NAV-7 | As a user, I see a proper branded favicon in the browser tab | âœ… Done | Blue chat bubble SVG favicon at `public/favicon.svg` |
| NAV-8 | As a user, the page title in the browser tab reflects the current page | âœ… Done | Dynamic title: "clofri Â· Friends", "clofri Â· Messages", etc. |
| NAV-9 | As a user, I see a 404 page when navigating to an unknown route | âœ… Done | `NotFound` component with catch-all `*` route |
| NAV-10 | As a user, I see an unread badge on the Groups nav item | âœ… Done | Blue dot on Groups nav matching Messages nav badge |
| NAV-11 | As a mobile user, the GroupChat members panel overlays the chat instead of pushing it off-screen | âœ… Done | Fixed overlay with backdrop on mobile; flex sidebar on desktop |
| NAV-12 | As a mobile user, I can access invite code and actions (End Session/Leave) from the members panel | âœ… Done | Invite code + actions added to mobile members overlay |
| NAV-13 | As a mobile user, I can toggle notification sounds from the sidebar | âœ… Done | Sound toggle with label in both mobile and desktop sidebars |
| NAV-14 | As a user, mobile browser chrome matches the app's dark theme | âœ… Done | `<meta name="theme-color" content="#09090b">` |
| NAV-15 | As a user, the app has a meta description for link previews | âœ… Done | `<meta name="description">` in index.html |

---

## 3. Technical Architecture Summary

| Layer | Technology | Purpose |
|-------|-----------|---------|
| Frontend | React + TypeScript + Vite | UI rendering, routing, state |
| Styling | TailwindCSS | Utility-first CSS |
| State | Zustand | Client state management (auth, groups, DMs, friends, presence, categories) |
| Auth | Supabase Auth | Magic link email, Google OAuth (not configured) |
| Database | Supabase Postgres | Profiles, friendships, groups, messages, dm_sessions, direct_messages |
| Real-time | Supabase Realtime (Broadcast + Presence) | Chat messages, typing indicators, online status, DM/session notifications |
| Security | Row Level Security (RLS) | All tables have RLS policies enforcing access control |
| Storage | localStorage | Unread timestamps, sidebar state, sound preference, friend categories |

### Key Data Tables
- **profiles** â€” User identity (display_name, avatar_url, friend_code)
- **friendships** â€” Friend relationships (requester, addressee, status)
- **groups** â€” Chat groups (name, creator, invite_code, is_active)
- **group_members** â€” Group membership (group_id, user_id, role)
- **messages** â€” Group messages (group_id, user_id, text)
- **dm_sessions** â€” DM session lifecycle (user1_id, user2_id, is_active)
- **direct_messages** â€” DM messages (sender_id, receiver_id, session_id, text)

---

## 4. Known Gaps & Future Work

### Short-term (polish before deploy)
- ~~**CAT-7/8**: Collapsible category sections~~ âœ…
- ~~**NAV-7**: Branded favicon~~ âœ…
- ~~**GRP-11**: Group session ended notification~~ âœ…
- ~~**DM-13**: Conversation ended toast~~ âœ…
- ~~**NOTIF-10**: Global group message notifications~~ âœ…
- ~~**FRI-11**: Real-time friend request notifications~~ âœ…
- ~~**FRI-12**: Search/filter friends by name~~ âœ…
- ~~**NAV-8**: Dynamic page titles~~ âœ…
- ~~**UI Audit Round 1**: Mobile touch, 404 route, input validation, nav badges, tag menu, sound toggle, meta tags~~ âœ…
- ~~**UI Audit Round 2**: Mobile overlay sidebar, leave confirmation, console cleanup, maxLength on all inputs, theme-color~~ âœ…
- ~~**Chat Best Practices**: Smart auto-scroll, message grouping, auto-focus, clickable URLs~~ âœ…
- ~~**AUTH-8**: Customized magic link email template (Supabase dashboard config)~~ âœ…
- **AUTH-6**: Google OAuth configuration (Google Cloud Console setup) â€” *optional, can do post-deploy*

### Medium-term (post-validation)
- **Persistent groups (paid)** â€” `is_persistent` flag for premium groups that keep messages
- **Push notifications** â€” Web push for background alerts
- **Custom avatar uploads** â€” Supabase Storage integration
- **Media messages** â€” Image sharing in chat
- **Friend categories sync** â€” Migrate from localStorage to Supabase
- **Message reactions** â€” Emoji reactions on messages
- **Rate limiting** â€” Server-side message throttling

### Long-term
- **Mobile app** â€” React Native reusing same backend
- **Voice rooms** â€” WebRTC audio channels
- **E2E encryption** â€” Optional per-group encryption
- **Threads** â€” Reply threads within chats
