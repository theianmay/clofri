# clofri â€” Key Processes & Workflows

Complete inventory of every user-facing workflow, the files involved, data flow, error handling status, and audit findings.

---

## 1. Authentication & Session Bootstrap

### Flow
1. `App.tsx` renders â†’ calls `authStore.initialize()` on mount
2. `initialize()` calls `supabase.auth.getSession()` to restore any existing session
3. If session exists, calls `fetchOrCreateProfile()` to fetch/create the user's profile row
4. Sets `loading: false` â€” app renders either `<Login />` or `<Layout />` + routes
5. Registers `onAuthStateChange` listener for future login/logout events

### Files
- `src/App.tsx` â€” top-level loading gate (`loading` â†’ spinner, `!user` â†’ Login, else â†’ routes)
- `src/stores/authStore.ts` â€” `initialize`, `signInWithMagicLink`, `signInWithGoogle`, `signOut`, `updateProfile`, `fetchOrCreateProfile`
- `src/lib/supabase.ts` â€” Supabase client singleton, env var validation

### Sub-flows
- **Magic link sign-in**: `Login.tsx` â†’ `signInWithMagicLink(email)` â†’ Supabase OTP â†’ email link â†’ `onAuthStateChange` fires â†’ profile fetched â†’ app loads
- **Google OAuth sign-in**: `signInWithGoogle()` â†’ Supabase OAuth redirect â†’ callback â†’ `onAuthStateChange`
- **Sign out**: `signOut()` â†’ `supabase.auth.signOut()` â†’ state cleared â†’ shows `<Login />`
- **Profile update** (display name, avatar): `updateProfile()` â†’ Supabase `.update()` â†’ local state updated

### PRD Coverage
AUTH-1 through AUTH-8 (Â§2.2)

### Audit Status: PASS
- `initialize()` has try-catch â€” `loading` always resolves to `false`
- `fetchOrCreateProfile` handles race conditions (duplicate key â†’ retry SELECT)
- `signInWithMagicLink` has try-catch â€” returns user-facing error on network failure
- `signOut` has no try-catch but is fire-and-forget (acceptable â€” clears local state regardless)
- `updateProfile` silently fails on error (acceptable â€” non-critical, no loading gate)
- `onAuthStateChange` callback has try-catch

---

## 2. Profile Management

### Flow
1. Profile auto-created on first login via `fetchOrCreateProfile()` in authStore
2. Display name defaults to `full_name` from OAuth metadata, or email prefix, or "Anonymous"
3. Friend code auto-generated by database (8-char uppercase)
4. User edits display name inline in sidebar â†’ `updateProfile()` â†’ Supabase `.update()` â†’ local state
5. User picks avatar from AvatarPicker â†’ `updateProfile({ avatar_url: 'icon:cat' })` â†’ persisted

### Files
- `src/stores/authStore.ts` â€” `updateProfile`, `fetchOrCreateProfile`
- `src/components/Layout.tsx` â€” inline display name editing, avatar picker trigger, friend code copy, share link
- `src/components/AvatarPicker.tsx` â€” icon grid modal
- `src/components/AvatarIcon.tsx` â€” renders icon/image/initial avatars

### Sub-flows
- **Edit display name**: click pencil â†’ inline input â†’ blur/Enter saves â†’ `updateProfile({ display_name })`
- **Pick avatar**: click avatar â†’ AvatarPicker modal â†’ select icon â†’ `updateProfile({ avatar_url: 'icon:id' })`
- **Copy friend code**: click copy button â†’ `navigator.clipboard.writeText()` â†’ checkmark feedback
- **Share profile link**: click share â†’ copies URL with friend code query param

### PRD Coverage
PROF-1 through PROF-6 (Â§2.2). PROF-5 (custom image upload) is ğŸ”² Future.

### Audit Status: PASS
- `updateProfile` has no loading gate â€” failures are silent but non-blocking
- Friend code copy uses clipboard API with no fallback, but acceptable for modern browsers

---

## 3. Presence & Online Status

### Flow
1. `Layout.tsx` calls `presenceStore.join(profile)` when profile is available
2. `join()` creates a Supabase Realtime channel named `"lobby"` with presence keyed by user ID
3. Tracks `{ user_id, display_name, avatar_url, status, last_active, status_message, auto_reply }`
4. Activity listeners (`mousemove`, `keydown`, `pointerdown`, `scroll`, `visibilitychange`) manage idle detection
5. Heartbeat interval (60s) keeps `last_active` fresh for active users
6. `resolveStatus()` treats users with stale `last_active` (>6 min) as idle even if tracked as active
7. Lobby channel also receives broadcast events: `new_dm`, `dm_ended`, `friend_request`, `new_group_msg`, `group_ended`
8. `leave()` cleans up listeners, timers, and unsubscribes

### Files
- `src/stores/presenceStore.ts` â€” all presence logic, lobby channel, broadcast listeners
- `src/components/Layout.tsx` â€” `join`/`leave` lifecycle tied to `profile.id`

### Sub-flows
- **Status message**: `setStatusMessage()` â†’ updates localStorage + re-tracks presence with new message
- **Auto-reply toggle**: `setAutoReply()` â†’ updates localStorage + re-tracks presence
- **DM notification (lobby)**: `new_dm` event â†’ marks session unread, plays sound, re-fetches sessions
- **DM ended (lobby)**: `dm_ended` event â†’ plays sound, re-fetches sessions
- **Friend request (lobby)**: `friend_request` event â†’ plays sound, re-fetches friends list
- **Group message (lobby)**: `new_group_msg` event â†’ marks group unread, plays sound
- **Group ended (lobby)**: `group_ended` event â†’ plays sound, re-fetches groups

### PRD Coverage
PRES-1 through PRES-7 (Â§2.8)

### Audit Status: PASS (minor notes)
- `join()` guards against double-join
- `leave()` properly cleans up all timers and listeners
- Broadcast listeners are non-critical â€” dynamic imports used for `friendStore`/`groupStore` to avoid circular deps
- No try-catch inside `channel.subscribe` callback, but `trackStatus` is fire-and-forget (acceptable)
- `setStatusMessage`/`setAutoReply` iterate presence state to find own entry â€” fragile if presence state is momentarily empty, but harmless (just no-ops)

---

## 4. Friends System

### Flow
1. `Friends.tsx` calls `friendStore.fetchFriends()` on mount + on tab visibility change
2. `fetchFriends()` queries `friendships` table â†’ fetches related `profiles` â†’ sorts into `friends`, `pendingReceived`, `pendingSent`
3. UI renders buddy list with categories, search, online status indicators

### Files
- `src/components/Friends.tsx` â€” full friends UI, search, categories, add friend form
- `src/stores/friendStore.ts` â€” `fetchFriends`, `sendRequest`, `acceptRequest`, `rejectRequest`, `removeFriend`
- `src/stores/categoryStore.ts` â€” local-only (localStorage) category management

### Sub-flows
- **Send friend request**: `sendRequest(code)` â†’ validates profile exists â†’ finds target by friend_code â†’ checks for existing friendship â†’ inserts â†’ broadcasts via lobby â†’ re-fetches
- **Accept request**: `acceptRequest(id)` â†’ updates friendship status to `accepted` â†’ re-fetches
- **Reject request**: `rejectRequest(id)` â†’ deletes friendship row â†’ re-fetches
- **Remove friend**: `removeFriend(id)` â†’ deletes friendship row â†’ re-fetches
- **Start DM from friend**: `handleStartDM` â†’ `dmStore.startSession(friendId)` â†’ navigates to `/dm/:sessionId`
- **Categories** (local): `addCategory`, `removeCategory`, `assignFriend` â€” all localStorage, no Supabase

### PRD Coverage
FRI-1 through FRI-13 (Â§2.3)

### Audit Status: PASS
- `fetchFriends()` has try-catch
- `sendRequest` has comprehensive try-catch with user-facing error messages
- `acceptRequest`, `rejectRequest`, `removeFriend` have try-catch

---

## 5. Friend Categories

### Flow
1. Categories are stored entirely in localStorage (not synced to Supabase)
2. User creates a category â†’ auto-assigned color from palette â†’ stored in `clofri-friend-categories`
3. User assigns a friend to a category â†’ stored in `clofri-friend-assignments` (friendshipId â†’ categoryId)
4. Friends page groups friends by category in collapsible sections
5. Filter dropdown allows viewing only one category at a time

### Files
- `src/stores/categoryStore.ts` â€” `addCategory`, `removeCategory`, `renameCategory`, `assignFriend`, `getCategoryForFriend`
- `src/components/Friends.tsx` â€” category sections, filter dropdown, assignment UI

### Sub-flows
- **Create category**: enter name â†’ `addCategory(name)` â†’ auto-color â†’ localStorage
- **Assign friend**: dropdown on friend card â†’ `assignFriend(friendshipId, categoryId)` â†’ localStorage
- **Delete category**: confirm dialog â†’ `removeCategory(id)` â†’ removes category + all its assignments
- **Filter by category**: dropdown at top â†’ filters visible friends list

### PRD Coverage
CAT-1 through CAT-8 (Â§2.4). CAT-6 (cross-device sync) is ğŸ”² Future.

### Audit Status: PASS
- All operations are synchronous localStorage â€” no network calls, no loading states needed
- `loadCategories`/`loadAssignments` have try-catch for corrupted localStorage
- Data is local-only â€” lost on browser data clear (documented as known limitation)

---

## 6. Direct Messages (DM Sessions)

### Flow
1. `Messages.tsx` calls `dmStore.fetchSessions()` on mount + polls every 15s
2. `fetchSessions()` queries active `dm_sessions` â†’ fetches friend profiles â†’ checks unread status â†’ auto-cleans stale sessions on initial fetch
3. User clicks a session â†’ navigates to `/dm/:sessionId` â†’ `DMChat.tsx` mounts
4. `DMChat.tsx` uses `useDMChat` hook which:
   - Fetches message history from `direct_messages` table (last 50)
   - Creates a Supabase Realtime channel `dm-session:{sessionId}`
   - Listens for broadcast `message`, `typing`, `nudge` events
5. Sending a message: optimistic local add â†’ broadcast to DM channel â†’ broadcast `new_dm` on lobby â†’ persist to DB
6. Ending a session: delete messages â†’ mark session inactive â†’ broadcast `dm_ended` on lobby â†’ re-fetch sessions

### Files
- `src/components/Messages.tsx` â€” DM session list with unread indicators
- `src/components/DMChat.tsx` â€” chat UI, input, nudge, end chat
- `src/hooks/useDMChat.ts` â€” realtime channel, message history, send/typing/nudge
- `src/stores/dmStore.ts` â€” `fetchSessions`, `startSession`, `endSession`, `markRead`

### Sub-flows
- **Stale session cleanup**: On initial fetch, sessions where friend is offline + no activity for 30min are auto-ended
- **Unread detection**: Compares latest message `created_at` vs localStorage `last_read` timestamp
- **Auto-reply**: If friend is idle + has auto-reply enabled + has status message â†’ injects a local-only auto-reply bubble after first sent message
- **Session ended redirect**: If session disappears from store while viewing, shows "Conversation ended" for 2s then redirects
- **Offline friend**: Input is disabled with a "Friend is offline" notice

### PRD Coverage
DM-1 through DM-14 (Â§2.5). DM-14 (scroll pagination) is ğŸ”² Future.

### Audit Status: PASS
- `fetchSessions()` has try-catch
- `startSession()` has try-catch
- `endSession()` has try-catch
- `useDMChat` `fetchHistory` has try-catch

---

## 7. Group Chat

### Flow
1. `Home.tsx` calls `groupStore.fetchGroups()` on mount
2. `fetchGroups()` queries `group_members` â†’ `groups` (active only) â†’ member profiles â†’ checks unread
3. User clicks a group â†’ navigates to `/group/:groupId` â†’ `GroupChat.tsx` mounts
4. `GroupChat.tsx` uses `useChat` hook which:
   - Fetches message history from `messages` table (last 50)
   - Creates a Supabase Realtime channel `group:{groupId}` with presence
   - Listens for broadcast `message`, `typing`, `nudge` events
   - Tracks presence per-member for online indicators
5. Sending: optimistic local â†’ broadcast on group channel â†’ broadcast `new_group_msg` on lobby â†’ persist to DB

### Files
- `src/components/Home.tsx` â€” group list, create/join forms
- `src/components/GroupChat.tsx` â€” chat UI, member sidebar, invite code, actions
- `src/hooks/useChat.ts` â€” realtime channel, presence, message history, send/typing/nudge
- `src/stores/groupStore.ts` â€” `fetchGroups`, `createGroup`, `joinGroupByCode`, `leaveGroup`, `endGroupSession`, `deleteGroup`, `kickMember`, `checkUnread`

### Sub-flows
- **Create group**: generates random invite code â†’ inserts group â†’ adds creator as member â†’ navigates to group
- **Join by code**: finds group by invite_code â†’ inserts member (handles duplicate key) â†’ navigates
- **End session (creator)**: deletes messages â†’ marks inactive â†’ removes all members â†’ broadcasts `group_ended`
- **Leave group**: deletes own membership â†’ re-fetches
- **Kick member**: creator deletes another member's row â†’ re-fetches
- **Redirect on ended**: if group disappears from store while viewing, redirects to `/groups`

### PRD Coverage
GRP-1 through GRP-13 (Â§2.6), CHAT-1 through CHAT-15 (Â§2.7).
CHAT-9 (media), CHAT-10 (reactions), CHAT-11 (link previews) are ğŸ”² Future.

### Audit Status: PASS
- `fetchGroups()` has try-catch
- `joinGroupByCode()` has try-catch
- `createGroup()` has try-catch
- `leaveGroup()`, `endGroupSession()`, `deleteGroup()`, `kickMember()` have try-catch
- `useChat` `fetchHistory` has try-catch

---

## 8. Realtime Messaging (Shared Patterns)

### Pattern: Chat Hooks (`useChat`, `useDMChat`)
1. On mount: fetch history from DB â†’ subscribe to Supabase Realtime channel
2. Messages: broadcast-based (not DB-listen) for instant delivery, persisted to DB after
3. Typing: broadcast throttled (2s cooldown), auto-clears after 3s on receiver
4. Nudge: broadcast + sound + vibration + visual shake
5. On unmount: `supabase.removeChannel(channel)`

### Audit Status: PASS
- Both hooks' `fetchHistory` functions have try-catch
- Message deduplication by ID is correct
- Ring buffer (50 messages) is correct
- Channel cleanup on unmount is correct

---

## 9. Notifications & Unread Indicators

### Flow
1. **Sound notifications**: Web Audio API synthesized sounds â€” message pop + nudge buzz
2. **DM unread**: `fetchSessions()` compares latest `direct_messages.created_at` vs localStorage `clofri-dm-last-read` per session
3. **Group unread**: `checkUnread()` compares latest `messages.created_at` vs localStorage `clofri-last-visited` per group
4. **Cross-page DM alerts**: lobby channel `new_dm` broadcast â†’ presenceStore handler â†’ marks unread + plays sound
5. **Cross-page group alerts**: lobby channel `new_group_msg` broadcast â†’ presenceStore handler â†’ marks unread + plays sound (skipped if user is currently viewing that group)
6. **Session-end alerts**: `dm_ended` / `group_ended` lobby broadcasts â†’ sound + re-fetch
7. **Friend request alert**: `friend_request` lobby broadcast â†’ sound + re-fetch friends
8. **Nav badges**: Layout reads `unreadDMs.size` and `unreadGroups.size` for badge counts
9. **Mark as read**: `markRead()` called on chat mount â†’ updates localStorage timestamp + removes from unread Set

### Files
- `src/lib/sounds.ts` â€” `playMessageSound`, `playNudgeSound`, `isSoundEnabled`, `setSoundEnabled`
- `src/stores/presenceStore.ts` â€” lobby broadcast listeners for all notification events
- `src/stores/dmStore.ts` â€” `unreadDMs`, `markRead`, unread checking in `fetchSessions`
- `src/stores/groupStore.ts` â€” `unreadGroups`, `markRead`, `checkUnread`
- `src/components/Layout.tsx` â€” sound toggle, nav badges

### PRD Coverage
NOTIF-1 through NOTIF-10 (Â§2.9). NOTIF-9 (push notifications) is ğŸ”² Future.

### Audit Status: PASS
- Sound functions have try-catch (AudioContext may not be available)
- Unread detection is localStorage-based â€” consistent within a single browser, not cross-device
- Sound toggle persisted in localStorage

---

## 10. Sound System

### Flow
- `sounds.ts` uses Web Audio API to generate sounds programmatically (no audio files)
- `playMessageSound()`: two-tone sine wave "pop"
- `playNudgeSound()`: sawtooth + square wave buzz
- Sound preference persisted in localStorage (`clofri-sound-enabled`)
- Toggle in sidebar (`Layout.tsx`)

### Audit Status: PASS
- Both functions have try-catch (audio context may not be available)
- Handles suspended AudioContext state

---

## 11. UI Infrastructure

### Connection Banner (`ConnectionBanner.tsx`)
- Listens for browser `online`/`offline` events
- Shows red "You're offline" banner when disconnected
- Shows green "Back online" banner for 3s after reconnection
- **Audit: PASS** â€” Note: only detects full browser offline, not Supabase Realtime channel drops (see PRD Gap #1 below)

### Error Boundary (`ErrorBoundary.tsx`)
- Class component wrapping each route in `App.tsx`
- Catches render errors, shows "Something went wrong" with retry button
- **Audit: PASS**

### Confirm Dialog (`ConfirmDialog.tsx`)
- Modal with Escape key support, auto-focus on confirm button
- Used for: remove friend, delete category, end DM, end/leave group, kick member
- **Audit: PASS**

### Avatar System (`AvatarIcon.tsx`, `AvatarPicker.tsx`)
- 25 predefined Lucide icon avatars stored as `icon:{id}` in `avatar_url`
- Falls back to URL-based avatar, then initial letter
- **Audit: PASS**

### Layout & Navigation (`Layout.tsx`)
- Collapsible desktop sidebar (w-64/w-14) with localStorage persistence
- Mobile hamburger slide-out
- User profile section: editable display name, avatar picker, status message, auto-reply, friend code copy, share link, sound toggle, sign out
- Unread badges on Messages and Groups nav items
- Dynamic page title based on route
- **Audit: PASS** â€” `updateProfile` and `saveName` don't block UI

---

## Issues Found & Fixed During Audit

All issues below have been **fixed** in the codebase.

| # | Issue | File(s) | Severity | Status |
|---|-------|---------|----------|--------|
| 1 | `onAuthStateChange` callback lacked try-catch | `authStore.ts` | Medium | âœ… Fixed |
| 2 | `acceptRequest`, `rejectRequest`, `removeFriend` lacked try-catch | `friendStore.ts` | Medium | âœ… Fixed |
| 3 | `fetchHistory` in both chat hooks lacked try-catch | `useChat.ts`, `useDMChat.ts` | Low-Med | âœ… Fixed |
| 4 | `createGroup` lacked try-catch (spinner could get stuck) | `groupStore.ts` | Medium | âœ… Fixed |
| 5 | `leaveGroup`, `endGroupSession`, `deleteGroup`, `kickMember` lacked try-catch | `groupStore.ts` | Medium | âœ… Fixed |
| 6 | `signInWithMagicLink` lacked try-catch (Login spinner could get stuck) | `authStore.ts` | Medium | âœ… Fixed |

---

## PRD Cross-Reference

### Full Coverage (all stories audited)
| PRD Section | PROCESSES Section | Stories |
|-------------|-------------------|--------|
| Â§2.1 Authentication | Â§1 | AUTH-1 through AUTH-8 |
| Â§2.2 Profile Management | Â§2 | PROF-1 through PROF-6 |
| Â§2.3 Friends | Â§4 | FRI-1 through FRI-13 |
| Â§2.4 Friend Categories | Â§5 | CAT-1 through CAT-8 |
| Â§2.5 Direct Messages | Â§6 | DM-1 through DM-14 |
| Â§2.6 Groups | Â§7 | GRP-1 through GRP-13 |
| Â§2.7 Chat (Real-time) | Â§7, Â§8 | CHAT-1 through CHAT-15 |
| Â§2.8 Presence | Â§3 | PRES-1 through PRES-7 |
| Â§2.9 Notifications | Â§9 | NOTIF-1 through NOTIF-10 |
| Â§2.10 Navigation & Layout | Â§11 | NAV-1 through NAV-15 |

### PRD Gaps (implemented features with no PRD story)
| Feature | Location | Notes |
|---------|----------|-------|
| **Nudge** (shake + sound + vibration) | `useChat.ts`, `useDMChat.ts`, `DMChat.tsx`, `GroupChat.tsx` | No PRD story; works in both DM and group chat |
| **Status message** | `presenceStore.ts`, `Layout.tsx` | No PRD story; shown below display name in sidebar |
| **Auto-reply** | `presenceStore.ts`, `useDMChat.ts`, `Layout.tsx` | No PRD story; sends auto-reply when idle + enabled |
| **Share profile link** | `Layout.tsx` | No PRD story; copies URL with friend code query param |

### PRD/Implementation Mismatches
| ID | PRD Claim | Actual Implementation | Severity |
|----|-----------|----------------------|----------|
| NAV-4 | "connection banner when real-time connection drops" | `ConnectionBanner.tsx` only detects full browser offline (`navigator.onLine`), not Supabase Realtime channel disconnection | Low â€” Supabase client has its own reconnection logic; banner is supplementary |

---

## Data Flow Summary

```
Browser â†â†’ Supabase Auth (session/tokens)
Browser â†â†’ Supabase DB (profiles, friendships, dm_sessions, direct_messages, groups, group_members, messages)
Browser â†â†’ Supabase Realtime
              â”œâ”€â”€ "lobby" channel (presence + broadcasts: new_dm, dm_ended, friend_request, new_group_msg, group_ended)
              â”œâ”€â”€ "group:{id}" channels (presence + broadcasts: message, typing, nudge)
              â””â”€â”€ "dm-session:{id}" channels (broadcasts: message, typing, nudge)
```

## localStorage Keys
| Key | Purpose |
|-----|---------|
| `clofri-sidebar` | Sidebar collapsed/expanded state |
| `clofri-sound-enabled` | Sound preference |
| `clofri-status-message` | User's status message |
| `clofri-auto-reply` | Auto-reply toggle |
| `clofri-friend-categories` | Friend category definitions |
| `clofri-friend-assignments` | Friend â†’ category mappings |
| `clofri-dm-last-read` | Per-session last-read timestamps |
| `clofri-last-visited` | Per-group last-visited timestamps |
